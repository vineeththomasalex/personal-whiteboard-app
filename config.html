<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Whiteboard - Configuration</title>
    <script src="https://res.cdn.office.net/teams-js/2.19.0/js/MicrosoftTeams.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 32px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            height: 100vh;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .config-container {
            background: white;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }
        
        h1 {
            margin: 0 0 16px 0;
            color: #323130;
            font-size: 28px;
        }
        
        .subtitle {
            color: #605e5c;
            font-size: 16px;
            margin-bottom: 32px;
            line-height: 1.4;
        }
        
        .feature-list {
            text-align: left;
            margin: 24px 0;
            padding: 0;
            list-style: none;
        }
        
        .feature-list li {
            margin: 12px 0;
            padding: 12px 16px;
            background: #f3f2f1;
            border-radius: 6px;
            border-left: 4px solid #0078d4;
        }
        
        .feature-list li::before {
            content: "‚úÖ ";
            margin-right: 8px;
        }
        
        .save-btn {
            background-color: #0078d4;
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-top: 24px;
            transition: background-color 0.2s;
        }
        
        .save-btn:hover {
            background-color: #106ebe;
        }
        
        .save-btn:disabled {
            background-color: #d1d1d1;
            cursor: not-allowed;
        }
        
        .status {
            margin-top: 16px;
            padding: 12px;
            border-radius: 6px;
            font-weight: 500;
            display: none;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0078d4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="config-container">
        <h1>üé® Personal Whiteboard</h1>
        <div class="subtitle">
            Configure this app to enhance your Teams meetings with personal whiteboards and presenter sharing capabilities.
        </div>
        
        <ul class="feature-list">
            <li><strong>Personal Whiteboards:</strong> Each participant gets a private drawing space</li>
            <li><strong>Presenter Controls:</strong> Share selected whiteboards to the meeting stage</li>
            <li><strong>Privacy First:</strong> All drawings are session-only and explicitly shared</li>
            <li><strong>Easy to Use:</strong> Simple drawing tools with intuitive interface</li>
        </ul>
        
        <button class="save-btn" onclick="saveConfiguration()">
            <span id="btn-text">Save Configuration</span>
            <span id="btn-loading" class="loading" style="display: none;"></span>
        </button>
        
        <div id="status" class="status"></div>
    </div>

    <script>
        console.log('[CONFIG] üöÄ Personal Whiteboard Config page starting');
        console.log('[CONFIG] URL:', window.location.href);
        
        let teamsContext = null;

        // Initialize Teams SDK with logging
        console.log('[CONFIG] üì± Initializing Teams SDK...');
        microsoftTeams.app.initialize().then(() => {
            console.log('[CONFIG] ‚úÖ Teams config page initialized successfully');
            
            // Get Teams context
            console.log('[CONFIG] üìã Getting Teams context...');
            return microsoftTeams.app.getContext();
        }).then((context) => {
            teamsContext = context;
            console.log('[CONFIG] ‚úÖ Teams context received:', context);
            
            // Enable the save button once Teams is ready
            microsoftTeams.pages.config.registerOnSaveHandler((saveEvent) => {
                console.log('[CONFIG] üíæ Save handler called');
                // This is called when user clicks "Save" in Teams
                const baseUrl = window.location.origin + window.location.pathname.replace('config.html', '');
                console.log('[CONFIG] üîó Base URL:', baseUrl);
                
                const configData = {
                    contentUrl: baseUrl + 'stage.html',
                    entityId: 'personalWhiteboard',
                    suggestedDisplayName: 'Personal Whiteboard'
                };
                console.log('[CONFIG] ‚öôÔ∏è Setting config:', configData);
                
                microsoftTeams.pages.config.setConfig(configData);
                
                console.log('[CONFIG] ‚úÖ Notifying save success');
                saveEvent.notifySuccess();
            });
            
            // Indicate that configuration is valid
            console.log('[CONFIG] ‚úÖ Setting validity state to true');
            microsoftTeams.pages.config.setValidityState(true);
            
        }).catch((error) => {
            console.error('[CONFIG] ‚ùå Failed to initialize Teams config:', error);
            showStatus('Failed to initialize Teams configuration', 'error');
        });

        function saveConfiguration() {
            const btn = document.querySelector('.save-btn');
            const btnText = document.getElementById('btn-text');
            const btnLoading = document.getElementById('btn-loading');
            
            // Show loading state
            btn.disabled = true;
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline-block';
            
            // Simulate configuration save
            setTimeout(() => {
                // Hide loading state
                btn.disabled = false;
                btnText.style.display = 'inline';
                btnLoading.style.display = 'none';
                
                if (teamsContext) {
                    showStatus('‚úÖ Configuration saved successfully! You can now use Personal Whiteboard in your meetings.', 'success');
                    
                    // Auto-close after successful save (if in Teams)
                    setTimeout(() => {
                        try {
                            microsoftTeams.pages.config.setValidityState(true);
                        } catch (e) {
                            console.log('Not in Teams environment');
                        }
                    }, 2000);
                } else {
                    showStatus('‚ö†Ô∏è Configuration saved, but not running in Teams environment', 'error');
                }
            }, 1500);
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
            }
        }

        // For testing outside Teams
        if (!window.parent || window.parent === window) {
            console.log('Running in standalone mode');
            setTimeout(() => {
                showStatus('‚ÑπÔ∏è This is a preview. In Teams, this would configure the app for your organization.', 'success');
            }, 1000);
        }
    </script>
</body>
</html>